name: "Releaser"


on:
  pull_request:
    types: [closed]
    branches:
      - 'main'


jobs:

  update_documentation:
    name: "Doc Updater"
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - id: actions-docs
        uses: npalm/action-docs-action@v1.1.0
      - uses: stefanzweifel/git-auto-commit-action@v4.12.0
        with:
          commit_message: "update README"
          commit_options: '--no-verify --signoff'
          file_pattern: README.md

  release:
    name: "Releaser"
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - id: releaser
        uses: release-drafter/release-drafter@v5.15.0
        with:
          config-name: releaser_config.yml
          disable-autolabeler: true
          publish: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: "Trigger the Notifier"
        if: success()
        uses: peter-evans/repository-dispatch@v1.1.3
        with:
          token: ${{ secrets.CI_GH_PAT_REPO_DISPATCH_API_AUTH }}
          event-type: slack-notification
          client-payload: '{ "type": "build", "ref": "${{ github.ref }}", "sha": "${{ github.sha }}", "color": "#2EB67D", "title": "${{ github.repository }} New Release", "message": "üöÄ  Check-out ${{ steps.releaser.outputs.html_url }}" }'

  # notify_for_approval_bypass:
  #   name: "Notify"
  #   if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'approved') == false
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: "Trigger the Notifier"
  #       uses: peter-evans/repository-dispatch@v1.1.3
  #       with:
  #         token: ${{ secrets.CI_GH_PAT_REPO_DISPATCH_API_AUTH }}
  #         event-type: slack-notification
  #         client-payload: '{ "type": "alert", "ref": "${{ github.ref }}", "sha": "${{ github.sha }}", "color": "#ECB22E", "title": "${{ github.repository }} Merge to Main", "message": "‚ö†Ô∏è Approval flow bypassed for <https://github.com/${{ github.repository }}/pull/${{github.event.number}}|#${{github.event.number}}>." }'
