name: "Releaser"

on:
  pull_request:
    types: [closed]
    branches:
      - "main"

jobs:
  release:
    name: "Releaser"
    if: |
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'chore') == false &&
      contains(github.event.pull_request.labels.*.name, 'skip-changelog') == false &&
      contains(github.event.pull_request.labels.*.name, 'no-terraform') == false
    runs-on: ubuntu-latest
    steps:
      - id: releaser
        uses: release-drafter/release-drafter@v5.15.0
        with:
          config-name: releaser_config.yml
          disable-autolabeler: true
          publish: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: "Trigger the Notifier"
        if: steps.releaser.outputs.html_url != ''
        uses: peter-evans/repository-dispatch@v1.1.3
        with:
          token: ${{ secrets.CI_GH_PAT_REPO_DISPATCH_API_AUTH }}
          event-type: slack-notification
          client-payload: '{ "type": "build", "ref": "${{ github.ref }}", "sha": "${{ github.sha }}", "color": "#2EB67D", "title": "${{ github.repository }} New Release", "message": "ðŸš€  Check-out ${{ steps.releaser.outputs.html_url }}" }'
