name: "Scan"

on:
  pull_request:
  push:

defaults:
  run:
    shell: bash

jobs:
  vulnerability:
    name: "Vulnerability"
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
      - name: "Set Job Vars"
        id: vars
        run: |
          echo "::set-output name=task_version::$(cat ${{ github.workspace }}/.tool-versions | grep -w task | cut -d ' ' -f2)"
          if [[ ${{ github.event_name }} == 'push' && ${{ github.ref }} == "refs/heads/${{ github.event.repository.default_branch }}" ]]; then
            echo "::set-output name=commmit_info:: [Push on Main]"
          fi
      - name: 'Install asdf dependencies'
        uses: asdf-vm/actions/setup@v1
      - name: 'Install Task'
        uses: arduino/setup-task@v1
        with:
          version: ${{ steps.vars.outputs.task_version }}
      - name: 'Scan for Vulnerabilities'
        id: scan
        run: |
          task security -- sarif
          task docker:security -- sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: 'Upload SARIF reports'
        if: always()
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v1.0.30
        with:
          sarif_file: ./sarif-reports
      - name: 'Dedicated Grype scan for SARIF report creation'
        id: scan_grype
        uses: anchore/scan-action@v3.2.0
        with:
          path: "./"
          fail-build: true
          acs-report-enable: true
      - name: 'Upload SARIF Grype reports'
        if: always()
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v1.0.30
        with:
          sarif_file: ${{ steps.scan_grype.outputs.sarif }}
      - name: "Notify"
        if: failure()
        continue-on-error: true
        uses: peter-evans/repository-dispatch@v1.1.3
        with:
          token: ${{ secrets.CI_GH_PAT_REPO_DISPATCH_API_AUTH }}
          event-type: slack-notification
          client-payload: '{ "type": "alert", "ref": "${{ github.ref }}", "sha": "${{ github.sha }}", "color": "#FF0000", "title": "ðŸš¨ ${{ github.repository }} Vulnerability${{ steps.vars.outputs.commmit_info }}", "message": "Check https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" }'
